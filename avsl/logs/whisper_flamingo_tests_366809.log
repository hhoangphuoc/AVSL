Date              = Wed May 28 07:16:59 PM CEST 2025
Hostname          = ctit086
Working Directory = /home/s2587130/AVSL/avsl
Name of nodes used          : ctit086
Gpu devices                 : 3
Starting worker: 
Number of CPU cores = 16
SLURM_CPUS_PER_TASK:          16
# packages in environment at /home/s2587130/miniconda3/envs/whisper-flamingo:
#
# Name                    Version                   Build  Channel
_libgcc_mutex             0.1                        main  
_openmp_mutex             5.1                       1_gnu  
aiohappyeyeballs          2.4.4                    pypi_0    pypi
aiohttp                   3.10.11                  pypi_0    pypi
aiosignal                 1.3.1                    pypi_0    pypi
antlr4-python3-runtime    4.8                      pypi_0    pypi
async-timeout             5.0.1                    pypi_0    pypi
attrs                     25.3.0                   pypi_0    pypi
audioread                 3.0.1                    pypi_0    pypi
av                        12.3.0                   pypi_0    pypi
bitarray                  3.4.1                    pypi_0    pypi
bzip2                     1.0.8                h7f98852_4    conda-forge
ca-certificates           2025.4.26            hbd8a1cb_0    conda-forge
certifi                   2025.4.26                pypi_0    pypi
cffi                      1.17.1                   pypi_0    pypi
charset-normalizer        3.4.2                    pypi_0    pypi
colorama                  0.4.6                    pypi_0    pypi
cython                    3.1.1                    pypi_0    pypi
datasets                  3.1.0                    pypi_0    pypi
decorator                 5.2.1                    pypi_0    pypi
decord                    0.6.0                    pypi_0    pypi
dill                      0.3.8                    pypi_0    pypi
editdistance              0.6.0                    pypi_0    pypi
evaluate                  0.4.3                    pypi_0    pypi
fairseq                   1.0.0a0+272c4c5          pypi_0    pypi
ffmpeg                    4.2.2                h167e202_0    conda-forge
filelock                  3.16.1                   pypi_0    pypi
freetype                  2.10.4               h0708190_1    conda-forge
frozenlist                1.5.0                    pypi_0    pypi
fsspec                    2024.9.0                 pypi_0    pypi
gmp                       6.2.1                h58526e2_0    conda-forge
gnutls                    3.6.13               h85f3911_1    conda-forge
huggingface-hub           0.31.4                   pypi_0    pypi
hydra-core                1.0.7                    pypi_0    pypi
idna                      3.10                     pypi_0    pypi
importlib-metadata        8.5.0                    pypi_0    pypi
importlib-resources       6.4.5                    pypi_0    pypi
jinja2                    3.1.6                    pypi_0    pypi
joblib                    1.4.2                    pypi_0    pypi
lame                      3.100             h7f98852_1001    conda-forge
lazy-loader               0.4                      pypi_0    pypi
ld_impl_linux-64          2.40                 h12ee557_0  
libffi                    3.4.4                h6a678d5_1  
libgcc-ng                 11.2.0               h1234567_1  
libgomp                   11.2.0               h1234567_1  
libiconv                  1.17                 h166bdaf_0    conda-forge
libpng                    1.6.37               h21135ba_2    conda-forge
librosa                   0.11.0                   pypi_0    pypi
libstdcxx-ng              11.2.0               h1234567_1  
lightning-utilities       0.11.9                   pypi_0    pypi
llvmlite                  0.41.1                   pypi_0    pypi
lxml                      5.4.0                    pypi_0    pypi
mad                       0.15.1b              h9c3ff4c_1    conda-forge
markupsafe                2.1.5                    pypi_0    pypi
more-itertools            10.5.0                   pypi_0    pypi
mpmath                    1.3.0                    pypi_0    pypi
msgpack                   1.1.0                    pypi_0    pypi
multidict                 6.1.0                    pypi_0    pypi
multiprocess              0.70.16                  pypi_0    pypi
ncurses                   6.4                  h6a678d5_0  
nettle                    3.6                  he412f7d_0    conda-forge
networkx                  3.1                      pypi_0    pypi
numba                     0.58.1                   pypi_0    pypi
numpy                     1.24.4                   pypi_0    pypi
nvidia-cublas-cu12        12.1.3.1                 pypi_0    pypi
nvidia-cuda-cupti-cu12    12.1.105                 pypi_0    pypi
nvidia-cuda-nvrtc-cu12    12.1.105                 pypi_0    pypi
nvidia-cuda-runtime-cu12  12.1.105                 pypi_0    pypi
nvidia-cudnn-cu12         9.1.0.70                 pypi_0    pypi
nvidia-cufft-cu12         11.0.2.54                pypi_0    pypi
nvidia-curand-cu12        10.3.2.106               pypi_0    pypi
nvidia-cusolver-cu12      11.4.5.107               pypi_0    pypi
nvidia-cusparse-cu12      12.1.0.106               pypi_0    pypi
nvidia-nccl-cu12          2.20.5                   pypi_0    pypi
nvidia-nvjitlink-cu12     12.9.41                  pypi_0    pypi
nvidia-nvtx-cu12          12.1.105                 pypi_0    pypi
omegaconf                 2.0.6                    pypi_0    pypi
openai-whisper            20240930                 pypi_0    pypi
opencv-python             4.5.4.60                 pypi_0    pypi
openh264                  2.1.1                h780b84a_0    conda-forge
openssl                   3.0.16               h5eee18b_0  
packaging                 25.0                     pypi_0    pypi
pandas                    2.0.3                    pypi_0    pypi
pip                       24.0                     pypi_0    pypi
platformdirs              4.3.6                    pypi_0    pypi
pooch                     1.8.2                    pypi_0    pypi
portalocker               3.0.0                    pypi_0    pypi
propcache                 0.2.0                    pypi_0    pypi
protobuf                  5.29.4                   pypi_0    pypi
pyarrow                   17.0.0                   pypi_0    pypi
pycparser                 2.22                     pypi_0    pypi
python                    3.8.20               he870216_0  
python-dateutil           2.9.0.post0              pypi_0    pypi
python-speech-features    0.6                      pypi_0    pypi
pytorch-lightning         2.1.3                    pypi_0    pypi
pytz                      2025.2                   pypi_0    pypi
pyyaml                    6.0.2                    pypi_0    pypi
readline                  8.2                  h5eee18b_0  
regex                     2024.11.6                pypi_0    pypi
requests                  2.32.3                   pypi_0    pypi
sacrebleu                 2.5.1                    pypi_0    pypi
safetensors               0.5.3                    pypi_0    pypi
scikit-learn              1.3.2                    pypi_0    pypi
scipy                     1.10.1                   pypi_0    pypi
sentencepiece             0.1.96                   pypi_0    pypi
setuptools                75.1.0           py38h06a4308_0  
six                       1.17.0                   pypi_0    pypi
soundfile                 0.13.1                   pypi_0    pypi
sox                       14.4.2            h27f72bc_1013    conda-forge
soxr                      0.3.7                    pypi_0    pypi
sqlite                    3.45.3               h5eee18b_0  
sympy                     1.13.3                   pypi_0    pypi
tabulate                  0.9.0                    pypi_0    pypi
tensorboardx              2.6.2.2                  pypi_0    pypi
threadpoolctl             3.5.0                    pypi_0    pypi
tiktoken                  0.5.2                    pypi_0    pypi
tk                        8.6.14               h39e8969_0  
tokenizers                0.15.2                   pypi_0    pypi
torch                     2.4.1                    pypi_0    pypi
torchaudio                2.4.1                    pypi_0    pypi
torchmetrics              1.5.2                    pypi_0    pypi
tqdm                      4.67.1                   pypi_0    pypi
transformers              4.36.2                   pypi_0    pypi
triton                    3.0.0                    pypi_0    pypi
typing-extensions         4.13.2                   pypi_0    pypi
tzdata                    2025.2                   pypi_0    pypi
urllib3                   2.2.3                    pypi_0    pypi
wheel                     0.44.0           py38h06a4308_0  
x264                      1!152.20180806       h14c3975_0    conda-forge
xxhash                    3.5.0                    pypi_0    pypi
xz                        5.6.4                h5eee18b_1  
yarl                      1.15.2                   pypi_0    pypi
zipp                      3.20.2                   pypi_0    pypi
zlib                      1.2.13               h5eee18b_1  

==========================================================================
WHISPER-FLAMINGO FINETUNING TEST SCRIPTS
==========================================================================
Running all test cases to verify training readiness
This script is used to test the training script and the dataset loading script
It is used to verify that the training script is working correctly and that the dataset loading script is working correctly
It is used to verify that the video loading and tokenizer fixes are working correctly
It is used to verify that the dataset loading is working correctly
It is used to verify that the training pipeline is working correctly

==========================================================================
TEST 1/4: Robust Video Validation and Corruption Detection
==========================================================================
Running test/test_video_validation.py...

Project root: /home/s2587130/AVSL
Parent dir: /home/s2587130/AVSL/avsl
✅ HuggingFace Video utilities imported successfully
🧪 Starting robust video validation tests...
================================================================================
ROBUST VIDEO VALIDATION TEST
================================================================================
📂 Loading dataset from: /home/s2587130/AVSL/data/ami/av_hubert/train
✅ Dataset loaded: 60075 samples
🧪 Testing on first 100 samples
🔍 Validating 100 video samples...
✅ Validation complete: 78 valid, 22 corrupted

📊 VALIDATION RESULTS:
   Total samples tested: 100
   Valid videos: 78
   Corrupted videos: 22
   Success rate: 78.0%

🚨 CORRUPTED FILES DETAILS:
   1. Index 1: video_object_is_none
      File: unknown
   2. Index 2: video_object_is_none
      File: unknown
   3. Index 3: video_object_is_none
      File: unknown
   4. Index 13: video_object_is_none
      File: unknown
   5. Index 17: video_object_is_none
      File: unknown
   ... and 17 more
📄 Corrupted files report saved to: output/test_scripts/train_dataset/corrupted_videos_report.json

🎬 TESTING VIDEO LOADING:
   Testing sample 0...
   ✅ Loaded: (7, 88, 88, 1), dtype: float32
   Testing sample 4...
   ✅ Loaded: (81, 88, 88, 1), dtype: float32
   Testing sample 5...
   ✅ Loaded: (138, 88, 88, 1), dtype: float32
   Testing sample 6...
   ✅ Loaded: (12, 88, 88, 1), dtype: float32
   Testing sample 7...
   ✅ Loaded: (83, 88, 88, 1), dtype: float32

📈 Video loading success rate: 5/5

================================================================================
QUICK TEST RESULTS:
⚠️  Quick validation test found issues (expected)

================================================================================
RECOMMENDATION:
Running full dataset validation to identify all corrupted files...
================================================================================
FULL DATASET VIDEO VALIDATION
================================================================================
📂 Loading full dataset from: /home/s2587130/AVSL/data/ami/av_hubert/train
✅ Dataset loaded: 60075 samples
🔍 Validating 60075 video samples...
   Progress: 0/60075 (0.0%), Valid: 1, Corrupted: 0
   Progress: 1000/60075 (1.7%), Valid: 799, Corrupted: 202
   Progress: 2000/60075 (3.3%), Valid: 1605, Corrupted: 396
   Progress: 4000/60075 (6.7%), Valid: 3212, Corrupted: 789
   Progress: 7000/60075 (11.7%), Valid: 5618, Corrupted: 1383
   Progress: 8000/60075 (13.3%), Valid: 6426, Corrupted: 1575
   Progress: 9000/60075 (15.0%), Valid: 7239, Corrupted: 1762
   Progress: 10000/60075 (16.6%), Valid: 8058, Corrupted: 1943
   Progress: 12000/60075 (20.0%), Valid: 9663, Corrupted: 2338
   Progress: 13000/60075 (21.6%), Valid: 10492, Corrupted: 2509
   Progress: 14000/60075 (23.3%), Valid: 11303, Corrupted: 2698
   Progress: 15000/60075 (25.0%), Valid: 12133, Corrupted: 2868
   Progress: 16000/60075 (26.6%), Valid: 12937, Corrupted: 3064
   Progress: 17000/60075 (28.3%), Valid: 13758, Corrupted: 3243
   Progress: 18000/60075 (30.0%), Valid: 14579, Corrupted: 3422
   Progress: 19000/60075 (31.6%), Valid: 15394, Corrupted: 3607
   Progress: 21000/60075 (35.0%), Valid: 16983, Corrupted: 4018
   Progress: 22000/60075 (36.6%), Valid: 17789, Corrupted: 4212
   Progress: 23000/60075 (38.3%), Valid: 18603, Corrupted: 4398
   Progress: 26000/60075 (43.3%), Valid: 20998, Corrupted: 5003
   Progress: 27000/60075 (44.9%), Valid: 21815, Corrupted: 5186
   Progress: 28000/60075 (46.6%), Valid: 22633, Corrupted: 5368
   Progress: 29000/60075 (48.3%), Valid: 23437, Corrupted: 5564
   Progress: 30000/60075 (49.9%), Valid: 24249, Corrupted: 5752
   Progress: 32000/60075 (53.3%), Valid: 25855, Corrupted: 6146
   Progress: 33000/60075 (54.9%), Valid: 26678, Corrupted: 6323
   Progress: 34000/60075 (56.6%), Valid: 27507, Corrupted: 6494
   Progress: 36000/60075 (59.9%), Valid: 29138, Corrupted: 6863
   Progress: 37000/60075 (61.6%), Valid: 29951, Corrupted: 7050
   Progress: 40000/60075 (66.6%), Valid: 32381, Corrupted: 7620
   Progress: 42000/60075 (69.9%), Valid: 33985, Corrupted: 8016
   Progress: 44000/60075 (73.2%), Valid: 35623, Corrupted: 8378
   Progress: 46000/60075 (76.6%), Valid: 37257, Corrupted: 8744
   Progress: 48000/60075 (79.9%), Valid: 38866, Corrupted: 9135
   Progress: 49000/60075 (81.6%), Valid: 39668, Corrupted: 9333
   Progress: 52000/60075 (86.6%), Valid: 42050, Corrupted: 9951
   Progress: 53000/60075 (88.2%), Valid: 42847, Corrupted: 10154
   Progress: 54000/60075 (89.9%), Valid: 43637, Corrupted: 10364
   Progress: 56000/60075 (93.2%), Valid: 45268, Corrupted: 10733
   Progress: 59000/60075 (98.2%), Valid: 47684, Corrupted: 11317
   Progress: 60000/60075 (99.9%), Valid: 48490, Corrupted: 11511
✅ Validation complete: 48550 valid, 11525 corrupted

📊 FULL DATASET VALIDATION RESULTS:
   Total samples: 60075
   Valid videos: 48550
   Corrupted videos: 11525
   Success rate: 80.8%
📄 Corrupted files report saved to: output/test_scripts/train_dataset/full_dataset_corrupted_videos_report.json
💾 Saving clean dataset to: /home/s2587130/AVSL/data/ami/av_hubert/train_clean
✅ Clean dataset saved: 48550 samples

================================================================================
FINAL RESULTS:
Quick test: FOUND ISSUES
Full test: FOUND ISSUES
⚠️  Dataset contains corrupted videos (this is normal).
   Clean dataset has been created for training.
================================================================================

⚠️  TEST 1 COMPLETED: Corrupted videos identified and handled (expected)

==========================================================================
TEST 2/4: Video Loading and Tokenizer Verification
==========================================================================
Running test/debug_video_issue.py...

Project root: /home/s2587130/AVSL
Parent dir: /home/s2587130/AVSL/avsl
Debugging Video Loading Issues
==================================================
=== Testing Video Object Handling ===
✗ Error in video object handling test: No module named 'hf_video_utils'

=== Testing Tokenizer Fix ===
✓ Tokenizer created
Test tokens: tensor([50258, 50259, 50360, 50365,  1234,  -100,  5678,  -100, 50257])
Testing old decoding method...
✗ Old method failed (expected): can't convert negative int to unsigned
Testing new decoding method...
✓ New method result: 'но James'
✓ Valid tokens used: [tensor(1234), tensor(5678)]

==================================================
SUMMARY:
✓ Video object handling: FAILED
✓ Tokenizer fix: PASSED

❌ Some tests failed. Please review the errors above.

⚠️  TEST 2 COMPLETED: Some video/tokenizer issues detected (may be expected)

==========================================================================
TEST 3/4: Comprehensive HuggingFace Dataset Testing
==========================================================================
Running test/test_hf_dataset_comprehensive.py...

Project root: /home/s2587130/AVSL
Parent dir: /home/s2587130/AVSL/avsl
✅ Full HuggingFace Video utilities imported successfully
🧪 Comprehensive HuggingFace Dataset Testing
================================================================================
This test combines functionality from both test files and adds robust error handling.
================================================================================

================================================================================
Running: Dataset Structure and Loading
================================================================================
================================================================================
TEST 1: Dataset Structure and Loading
================================================================================

--- Testing Dataset: train ---
Path: /home/s2587130/AVSL/data/ami/av_hubert/train
✅ Dataset loaded successfully: 60075 samples
📋 Sample keys: ['id', 'meeting_id', 'speaker_id', 'start_time', 'end_time', 'duration', 'transcript', 'has_audio', 'has_video', 'has_lip_video', 'has_transcript', 'audio', 'video', 'lip_video']
   id: 'IB4010-C-2076.45-2076.72'
   meeting_id: 'IB4010'
   speaker_id: 'C'
   start_time: 2076.45
   end_time: 2076.72
   duration: 0.2699999999999818
   transcript: 'Uh-huh.'
   has_audio: True
   has_video: True
   has_lip_video: True
   has_transcript: True
   audio: array shape (4352,), sr=16000
   video: <class 'decord.video_reader.VideoReader'>
   lip_video: <class 'decord.video_reader.VideoReader'>
✅ All required fields present

--- Testing Dataset: validation ---
Path: /home/s2587130/AVSL/data/ami/av_hubert/validation
✅ Dataset loaded successfully: 6675 samples
📋 Sample keys: ['id', 'meeting_id', 'speaker_id', 'start_time', 'end_time', 'duration', 'transcript', 'has_audio', 'has_video', 'has_lip_video', 'has_transcript', 'audio', 'video', 'lip_video']
   id: 'ES2016d-C-185.71-209.52'
   meeting_id: 'ES2016d'
   speaker_id: 'C'
   start_time: 185.71
   end_time: 209.52
   duration: 23.810000000000002
   transcript: 'There is our the banana. Um yeah basically we went with the colour yellow. Um working on the princip...'
   has_audio: True
   has_video: True
   has_lip_video: True
   has_transcript: True
   audio: array shape (380864,), sr=16000
   video: <class 'decord.video_reader.VideoReader'>
   lip_video: <class 'decord.video_reader.VideoReader'>
✅ All required fields present

--- Testing Dataset: test ---
Path: /home/s2587130/AVSL/data/ami/av_hubert/test
✅ Dataset loaded successfully: 16688 samples
📋 Sample keys: ['id', 'meeting_id', 'speaker_id', 'start_time', 'end_time', 'duration', 'transcript', 'has_audio', 'has_video', 'has_lip_video', 'has_transcript', 'audio', 'video', 'lip_video']
   id: 'IS1007c-B-1685.37-1685.72'
   meeting_id: 'IS1007c'
   speaker_id: 'B'
   start_time: 1685.37
   end_time: 1685.72
   duration: 0.3500000000001364
   transcript: 'Mm.'
   has_audio: True
   has_video: True
   has_lip_video: True
   has_transcript: True
   audio: array shape (5520,), sr=16000
   video: <class 'decord.video_reader.VideoReader'>
   lip_video: <class 'decord.video_reader.VideoReader'>
✅ All required fields present

📊 Dataset Loading Summary:
   ✅ train: success
   ✅ validation: success
   ✅ test: success

✅ PASSED: Dataset Structure and Loading

================================================================================
Running: Video Processing (Basic)
================================================================================

--- Detailed Video Processing Test: test ---
Testing video processing on 5 samples...

--- Sample 0 ---

--- Debug HF Video Object (sample 0) ---
Type: <class 'decord.video_reader.VideoReader'>
Attributes: ['_hf_encoded', '_hf_bridge_out', '_handle', '_num_frame', '_key_indices', '_frame_pts', '_avg_fps']
String representation: <decord.video_reader.VideoReader object at 0x7f060cdef880>
--- End Debug ---

Warning: decord.VideoReader object found but no accessible path attribute
⚠️ Could not extract video path
✅ Video validation: True
✅ Robust video loading: (9, 88, 88, 1), dtype: float32
   Value range: [-1.885, 0.967]
✅ Audio: shape=(5520,), sr=16000
✅ Transcript: 'Mm.'
✅ Duration: 0.35 seconds

--- Sample 1 ---

--- Debug HF Video Object (sample 1) ---
Type: <class 'decord.video_reader.VideoReader'>
Attributes: ['_hf_encoded', '_hf_bridge_out', '_handle', '_num_frame', '_key_indices', '_frame_pts', '_avg_fps']
String representation: <decord.video_reader.VideoReader object at 0x7f04d27215e0>
--- End Debug ---

Warning: decord.VideoReader object found but no accessible path attribute
⚠️ Could not extract video path
✅ Video validation: True
✅ Robust video loading: (206, 88, 88, 1), dtype: float32
   Value range: [-1.695, 3.082]
✅ Audio: shape=(131616,), sr=16000
✅ Transcript: 'But can we find out uh about uh this chips? Becaus...'
✅ Duration: 8.23 seconds

--- Sample 2 ---

--- Debug HF Video Object (sample 2) ---
Type: <class 'decord.video_reader.VideoReader'>
Attributes: ['_hf_encoded', '_hf_bridge_out', '_handle', '_num_frame', '_key_indices', '_frame_pts', '_avg_fps']
String representation: <decord.video_reader.VideoReader object at 0x7f063f63bd60>
--- End Debug ---

Warning: decord.VideoReader object found but no accessible path attribute
⚠️ Could not extract video path
✅ Video validation: True
✅ Robust video loading: (73, 88, 88, 1), dtype: float32
   Value range: [-2.217, 1.656]
✅ Audio: shape=(46944,), sr=16000
✅ Transcript: 'The titanium and so it's very uh'
✅ Duration: 2.94 seconds

--- Sample 3 ---

--- Debug HF Video Object (sample 3) ---
Type: <class 'NoneType'>
Dir: []
String representation: None
--- End Debug ---

Warning: Could not extract path from video object: <class 'NoneType'>
Available attributes: []
⚠️ Could not extract video path
✅ Video validation: False
❌ Video validation failed
✅ Audio: shape=(11744,), sr=16000
✅ Transcript: 'Okay.'
✅ Duration: 0.74 seconds

--- Sample 4 ---

--- Debug HF Video Object (sample 4) ---
Type: <class 'decord.video_reader.VideoReader'>
Attributes: ['_hf_encoded', '_hf_bridge_out', '_handle', '_num_frame', '_key_indices', '_frame_pts', '_avg_fps']
String representation: <decord.video_reader.VideoReader object at 0x7f063c7ef3d0>
--- End Debug ---

Warning: decord.VideoReader object found but no accessible path attribute
⚠️ Could not extract video path
✅ Video validation: True
✅ Robust video loading: (24, 88, 88, 1), dtype: float32
   Value range: [-2.360, 2.726]
✅ Audio: shape=(15104,), sr=16000
✅ Transcript: 'you are two.'
✅ Duration: 0.95 seconds

📊 Video Processing Results:
   Successful: 4/5 (80.0%)
   Failed: 1/5 (20.0%)

✅ PASSED: Video Processing (Basic)

================================================================================
Running: Robust Video Filtering
================================================================================
================================================================================
TEST 3: Robust Video Filtering
================================================================================
Loading dataset for robust filtering...
Original dataset size: 13510
Running robust filtering on 100 samples...
🔍 Validating 100 video samples...
✅ Validation complete: 100 valid, 0 corrupted

📊 Robust Filtering Results:
   Total samples tested: 100
   Valid samples: 100
   Corrupted samples: 0
   Success rate: 100.0%
📄 Results saved to: output/test_scripts/video_filtering_test_results.json

✅ PASSED: Robust Video Filtering

================================================================================
Running: AmiVideoHFDataset Creation
================================================================================
================================================================================
TEST 4: AmiVideoHFDataset Creation
================================================================================
Importing training script components...

✅ HuggingFace Video utilities imported successfully


✓ AV-HuBERT user dir set to: /home/s2587130/AVSL/whisper_flamingo/av_hubert/avhubert


✓ Fairseq imported successfully from: /home/s2587130/AVSL/whisper_flamingo/av_hubert/fairseq/fairseq/__init__.py
✓ Fairseq checkpoint_utils and utils are accessible

✓ sys.argv length is 1, no dummy argument modification needed
✅ Training components imported successfully
✅ Using dataset: /home/s2587130/AVSL/data/ami/av_hubert/train (60075 samples)
Preparing dataset...
After basic filtering: 48550 samples (was 60075)
Using 3 samples for testing
Creating tokenizer...
✅ Tokenizer created successfully
Creating AmiVideoHFDataset...
AmiVideoHFDataset initialized for evaluation.
Target sample rate: 16000, Audio max length: 480000
✅ AmiVideoHFDataset created: 3 samples
Testing sample loading...

--- Debug HF Video Object (sample 0) ---
Type: <class 'decord.video_reader.VideoReader'>
Attributes: ['_hf_encoded', '_hf_bridge_out', '_handle', '_num_frame', '_key_indices', '_frame_pts', '_avg_fps']
String representation: <decord.video_reader.VideoReader object at 0x7f053f99bb80>
--- End Debug ---

✅ Sample 0 loaded successfully
   Keys: ['input_ids', 'labels', 'dec_input_ids', 'video']
   Input IDs shape: torch.Size([80, 3000])
   Labels shape: torch.Size([8])
   Dec input IDs shape: torch.Size([8])
   Video shape: torch.Size([7, 88, 88, 1])
   Video dtype: torch.float32
   Video range: [-1.980, 0.991]

--- Debug HF Video Object (sample 1) ---
Type: <class 'decord.video_reader.VideoReader'>
Attributes: ['_hf_encoded', '_hf_bridge_out', '_handle', '_num_frame', '_key_indices', '_frame_pts', '_avg_fps']
String representation: <decord.video_reader.VideoReader object at 0x7f04d849b6d0>
--- End Debug ---

✅ Sample 1 loaded successfully
   Keys: ['input_ids', 'labels', 'dec_input_ids', 'video']
   Input IDs shape: torch.Size([80, 3000])
   Labels shape: torch.Size([18])
   Dec input IDs shape: torch.Size([18])
   Video shape: torch.Size([81, 88, 88, 1])
   Video dtype: torch.float32
   Video range: [-2.455, 3.439]

--- Debug HF Video Object (sample 2) ---
Type: <class 'decord.video_reader.VideoReader'>
Attributes: ['_hf_encoded', '_hf_bridge_out', '_handle', '_num_frame', '_key_indices', '_frame_pts', '_avg_fps']
String representation: <decord.video_reader.VideoReader object at 0x7f04d849b790>
--- End Debug ---

✅ Sample 2 loaded successfully
   Keys: ['input_ids', 'labels', 'dec_input_ids', 'video']
   Input IDs shape: torch.Size([80, 3000])
   Labels shape: torch.Size([19])
   Dec input IDs shape: torch.Size([19])
   Video shape: torch.Size([138, 88, 88, 1])
   Video dtype: torch.float32
   Video range: [-2.312, 2.488]
✅ AmiVideoHFDataset test completed successfully

✅ PASSED: AmiVideoHFDataset Creation

================================================================================
Running: Dataset Format Compatibility
================================================================================
================================================================================
TEST 5: Dataset Format Compatibility
================================================================================
✅ av_hubert_train: 60075 samples
✅ av_hubert_val: 6675 samples
✅ av_hubert_test: 16688 samples

📋 Dataset Structure Comparison:
   av_hubert_train: ['audio', 'duration', 'end_time', 'has_audio', 'has_lip_video', 'has_transcript', 'has_video', 'id', 'lip_video', 'meeting_id', 'speaker_id', 'start_time', 'transcript', 'video']
   av_hubert_val: ['audio', 'duration', 'end_time', 'has_audio', 'has_lip_video', 'has_transcript', 'has_video', 'id', 'lip_video', 'meeting_id', 'speaker_id', 'start_time', 'transcript', 'video']
   av_hubert_test: ['audio', 'duration', 'end_time', 'has_audio', 'has_lip_video', 'has_transcript', 'has_video', 'id', 'lip_video', 'meeting_id', 'speaker_id', 'start_time', 'transcript', 'video']

🔗 Common keys across all datasets: ['audio', 'duration', 'end_time', 'has_audio', 'has_lip_video', 'has_transcript', 'has_video', 'id', 'lip_video', 'meeting_id', 'speaker_id', 'start_time', 'transcript', 'video']
✅ Dataset compatibility test completed

✅ PASSED: Dataset Format Compatibility

================================================================================
COMPREHENSIVE TEST SUMMARY
================================================================================
  ✅ PASSED: Dataset Structure and Loading
  ✅ PASSED: Video Processing (Basic)
  ✅ PASSED: Robust Video Filtering
  ✅ PASSED: AmiVideoHFDataset Creation
  ✅ PASSED: Dataset Format Compatibility

Overall: 5/5 tests passed

🎉 All tests passed! Your dataset is ready for training.
✅ You can proceed with running the training script.

📄 Test results logged to: output/test_scripts/
================================================================================

✅ TEST 3 PASSED: Comprehensive HuggingFace dataset testing successful

==========================================================================
TEST 4/4: Complete Training Pipeline Verification
==========================================================================
Running test/test_whisper_flamingo.py...

Project root: /home/s2587130/AVSL
Parent dir: /home/s2587130/AVSL/avsl
✓ Added fairseq path to sys.path: /home/s2587130/AVSL/whisper_flamingo/av_hubert/fairseq
✓ AV-HuBERT user dir set to: /home/s2587130/AVSL/whisper_flamingo/av_hubert/avhubert
✓ Fairseq imported successfully from: /home/s2587130/AVSL/whisper_flamingo/av_hubert/fairseq/fairseq/__init__.py
✓ Fairseq checkpoint_utils and utils are accessible
✓ Adding dummy argument to prevent AV-HuBERT task registration conflicts...
✓ sys.argv is now: ['test/test_whisper_flamingo.py', 'config/ami_whisper_flamingo_large.yaml', 'dummy']
Using config file: config/ami_whisper_flamingo_large.yaml
=== Whisper-Flamingo AMI Fine-tuning Comprehensive Test Suite ===
Testing all components from whisper_flamingo_ft_ami.py implementation
Based on successful AV-HuBERT task registration fix


======================================================================
Running: System Requirements
======================================================================

=== Testing System Requirements ===
PyTorch version: 2.4.1+cu121
✓ CUDA available: NVIDIA A40
  CUDA version: 12.1
  GPU memory: 47.7 GB
✓ Whisper-Flamingo repository: /home/s2587130/AVSL/whisper_flamingo
✓ AV-HuBERT submodule: /home/s2587130/AVSL/whisper_flamingo/av_hubert
✓ Fairseq installation: /home/s2587130/AVSL/whisper_flamingo/av_hubert/fairseq
✓ AMI HF datasets: /home/s2587130/AVSL/data/ami/av_hubert
✓ Configuration files: /home/s2587130/AVSL/avsl/config
✓ Training config: /home/s2587130/AVSL/avsl/config/ami_whisper_flamingo_large.yaml
✓ Training script: /home/s2587130/AVSL/avsl/whisper_flamingo_ft_ami.py
✓ AV-HuBERT weights: /home/s2587130/AVSL/avsl/models/large_noise_pt_noise_ft_433h_only_weights.pt
✓ Pre-trained Whisper weights: /home/s2587130/AVSL/avsl/models/whisper_en_large.pt
✅ System Requirements: PASSED

======================================================================
Running: Import Tests
======================================================================

=== Testing All Required Imports ===
✓ whisper_flamingo.whisper imported successfully
✓ torchaudio.transforms imported successfully
✓ pytorch_lightning core imports successful
✓ pytorch_lightning.strategies.DDPStrategy imported successfully
✓ whisper_flamingo.spec_augment imported successfully
✓ All whisper_flamingo.utils imports successful
✓ LengthBatchSampler imported successfully
✓ load_video_feats imported successfully
✅ Import Tests: PASSED

======================================================================
Running: Model Loading Tests
======================================================================

=== Testing Model Loading ===
Testing basic Whisper model loading...
Whisper dropout rate : 0.0
✓ Basic Whisper model loaded successfully
Testing Whisper-Flamingo model with exact training script configuration...
✓ Loaded config from: /home/s2587130/AVSL/avsl/config/ami_whisper_flamingo_large.yaml
Model configuration:
  Model name: large-v2
  Use AV-HuBERT: True
  Video model weights: /home/s2587130/AVSL/avsl/models/large_noise_pt_noise_ft_433h_only_weights.pt
  Weights exist: True
Testing with actual AV-HuBERT configuration...
Whisper dropout rate : 0.1
Loading AV-HuBERT encoder
Using AV-HuBERT encoder with parameters: 325136104
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
✓ Whisper-Flamingo with AV-HuBERT loaded successfully!
  Encoder type: <class 'whisper_flamingo.whisper.model.AudioEncoder'>
  Video model type: <class 'avhubert.hubert_asr.HubertEncoderWrapper'>
✅ Model Loading Tests: PASSED

======================================================================
Running: Dataset Loading Tests
======================================================================

=== Testing Dataset Loading ===
✓ train dataset loaded: 60075 samples
  Sample keys: ['id', 'meeting_id', 'speaker_id', 'start_time', 'end_time', 'duration', 'transcript', 'has_audio', 'has_video', 'has_lip_video', 'has_transcript', 'audio', 'video', 'lip_video']
  ✓ All required fields present
  Audio: shape=(4352,), sr=16000
  Transcript: 'Uh-huh.'
  Video: <class 'decord.video_reader.VideoReader'> - <decord.video_reader.VideoReader object at 0x7fade8573c10>
  ✓ Video frames accessible: 7 frames
  Duration: 0.27 seconds
✓ validation dataset loaded: 6675 samples
  Sample keys: ['id', 'meeting_id', 'speaker_id', 'start_time', 'end_time', 'duration', 'transcript', 'has_audio', 'has_video', 'has_lip_video', 'has_transcript', 'audio', 'video', 'lip_video']
  ✓ All required fields present
  Audio: shape=(380864,), sr=16000
  Transcript: 'There is our the banana. Um yeah basically we went...'
  Video: <class 'decord.video_reader.VideoReader'> - <decord.video_reader.VideoReader object at 0x7fadcb0f82b0>
  ✓ Video frames accessible: 595 frames
  Duration: 23.81 seconds
✓ test dataset loaded: 16688 samples
  Sample keys: ['id', 'meeting_id', 'speaker_id', 'start_time', 'end_time', 'duration', 'transcript', 'has_audio', 'has_video', 'has_lip_video', 'has_transcript', 'audio', 'video', 'lip_video']
  ✓ All required fields present
  Audio: shape=(5520,), sr=16000
  Transcript: 'Mm.'
  Video: <class 'decord.video_reader.VideoReader'> - <decord.video_reader.VideoReader object at 0x7fadde430a30>
  ✓ Video frames accessible: 9 frames
  Duration: 0.35 seconds

Testing dataset slicing (10% as in training)...
  train: 60075 -> 6007 samples (10%)
  validation: 6675 -> 667 samples (10%)
  test: 16688 -> 1668 samples (10%)
✅ Dataset Loading Tests: PASSED

======================================================================
Running: AmiVideoHFDataset Tests
======================================================================

=== Testing AmiVideoHFDataset Class ===

✅ HuggingFace Video utilities imported successfully


✓ AV-HuBERT user dir set to: /home/s2587130/AVSL/whisper_flamingo/av_hubert/avhubert


✓ Fairseq imported successfully from: /home/s2587130/AVSL/whisper_flamingo/av_hubert/fairseq/fairseq/__init__.py
✓ Fairseq checkpoint_utils and utils are accessible

✓ Dummy argument already present in sys.argv
✓ AmiVideoHFDataset imported successfully
✓ Loaded test dataset: 16688 samples
✓ Tokenizer created successfully
Creating AmiVideoHFDataset...
AmiVideoHFDataset initialized for evaluation.
Target sample rate: 16000, Audio max length: 480000
✓ AmiVideoHFDataset created with 5 samples
Testing sample retrieval...

--- Debug HF Video Object (sample 0) ---
Type: <class 'decord.video_reader.VideoReader'>
Attributes: ['_hf_encoded', '_hf_bridge_out', '_handle', '_num_frame', '_key_indices', '_frame_pts', '_avg_fps']
String representation: <decord.video_reader.VideoReader object at 0x7fade56ee490>
--- End Debug ---

✓ Sample retrieved successfully
  Keys: ['input_ids', 'labels', 'dec_input_ids', 'video']
  Input IDs shape: torch.Size([80, 3000])
  Labels shape: torch.Size([6])
  Dec input IDs shape: torch.Size([6])
  Video shape: torch.Size([9, 88, 88, 1])
✓ load_video_feats function available
✅ AmiVideoHFDataset Tests: PASSED

======================================================================
Running: Training Script Components
======================================================================

=== Testing Training Script Components ===
✓ Training script imported successfully
✓ AmiVideoHFDataset class imported successfully
✓ WhisperFlamingoModule class imported successfully
✅ Training Script Components: PASSED

======================================================================
Running: Configuration Loading
======================================================================

=== Testing Configuration Loading ===
✓ Configuration loaded from: /home/s2587130/AVSL/avsl/config/ami_whisper_flamingo_large.yaml
  Model name: large-v2
  Language: en
  Batch size: 2
  Learning rate: 1e-05
  Use AV-HuBERT: True
  Video model checkpoint: /home/s2587130/AVSL/avsl/models/large_noise_pt_noise_ft_433h_only_weights.pt
✓ Video model weights found: /home/s2587130/AVSL/avsl/models/large_noise_pt_noise_ft_433h_only_weights.pt
✓ Pre-trained checkpoint found: /home/s2587130/AVSL/avsl/models/whisper_en_large.pt
✅ Configuration Loading: PASSED

======================================================================
Running: WhisperFlamingoModule Creation
======================================================================

=== Testing WhisperFlamingoModule Creation ===
✓ Loaded config from: /home/s2587130/AVSL/avsl/config/ami_whisper_flamingo_large.yaml
✓ Loaded train dataset: 10 samples
✓ Loaded val dataset: 10 samples
✓ Loaded test dataset: 10 samples
✓ WhisperFlamingoModule imported successfully
AV-HuBERT weights exist: True
Use AV-HuBERT encoder: True
Testing WhisperFlamingoModule with AV-HuBERT...
Loading Whisper model and weights
Loading Whisper model =================================================
Whisper dropout rate : 0.1
Loading AV-HuBERT encoder
Using AV-HuBERT encoder with parameters: 325136104
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers
Adding gated x attn layers

✓ Whisper model loaded successfully


✓ Multilingual tokenizer : True, Language for dataset: en


✓ Using standard Whisper tokenizer with vocab size: 51865

✓ WhisperFlamingoModule with AV-HuBERT created successfully!
  Model type: <class 'whisper_flamingo.whisper.model.Whisper'>
  Encoder type: <class 'whisper_flamingo.whisper.model.AudioEncoder'>
  Decoder type: <class 'whisper_flamingo.whisper.model.TextDecoder'>
  Video model type: <class 'avhubert.hubert_asr.HubertEncoderWrapper'>
  Tokenizer vocab size: 51865
  Train audio lengths: 10
  Val audio lengths: 10
  Test audio lengths: 10
✅ WhisperFlamingoModule Creation: PASSED

======================================================================
Running: Data Loaders Tests
======================================================================

=== Testing Data Loaders ===
✓ DataLoader components imported successfully
✓ WhisperVideoCollatorWithPadding created successfully
✓ LengthBatchSampler created successfully
  Number of batches: 1
✅ Data Loaders Tests: PASSED

======================================================================
FINAL TEST RESULTS
======================================================================
✅ PASS   | System Requirements
✅ PASS   | Import Tests
✅ PASS   | Model Loading Tests
✅ PASS   | Dataset Loading Tests
✅ PASS   | AmiVideoHFDataset Tests
✅ PASS   | Training Script Components
✅ PASS   | Configuration Loading
✅ PASS   | WhisperFlamingoModule Creation
✅ PASS   | Data Loaders Tests

Overall: 9/9 tests passed

🎉 ALL TESTS PASSED!
✅ Your whisper_flamingo_ft_ami.py is ready for training!
✅ AV-HuBERT task registration fix is working correctly!

Next steps:
1. Ensure you have sufficient GPU resources
2. Verify your SLURM configuration (if using)
3. Run the training script:
   cd /home/s2587130/AVSL/avsl
   python whisper_flamingo_ft_ami.py config/ami_whisper_flamingo_large.yaml

✅ TEST 4 PASSED: Full training pipeline ready

==========================================================================
FINAL TEST RESULTS SUMMARY
==========================================================================
Test Results:
  ⚠️  Video Validation: COMPLETED (corrupted videos handled)
  ⚠️  Video/Tokenizer Fixes: COMPLETED (issues may be expected)
  ✅ Comprehensive Dataset Testing: PASSED
  ✅ Training Pipeline: PASSED

Overall Result: 4/4 tests passed/completed

🎉 TESTS COMPLETED SUCCESSFULLY! Your whisper-flamingo training is ready!

📋 Summary:
  - Corrupted videos have been identified and will be filtered out
  - Robust video handling is active
  - Dataset loading works with error handling
  - Comprehensive dataset testing passed
  - Training pipeline testing passed

🚀 To start training with clean data, run:
  sbatch scripts/train/whisper_flamingo_ft.sh

==========================================================================
Test suite completed at: Wed May 28 08:57:56 PM CEST 2025
==========================================================================
